

#include <string.h>
#include <stdio.h>
#include <stdint.h>
#include "test_pin.h"
#include "zero_page.h"
#include "hires.h"
#include "digit.h"


static const uint8_t digits[] =
{
    0x3F, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00, // 0
    0x0C, 0x0F, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00, // 1
    0x3F, 0x30, 0x30, 0x3F, 0x03, 0x03, 0x3F, 0x00, // 2
    0x3F, 0x30, 0x30, 0x3C, 0x30, 0x30, 0x3F, 0x00, // 3
    0x33, 0x33, 0x33, 0x3F, 0x30, 0x30, 0x30, 0x00, // 4
    0x3F, 0x03, 0x03, 0x3F, 0x30, 0x30, 0x3F, 0x00, // 5
    0x03, 0x03, 0x03, 0x3F, 0x33, 0x33, 0x3F, 0x00, // 6
    0x3F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, // 7
    0x3F, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x3F, 0x00, // 8
    0x3F, 0x33, 0x33, 0x3F, 0x30, 0x30, 0x30, 0x00, // 9
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // blank
};

static const uint8_t digit_ones[0x100] =
{
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 0
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 10
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 20
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 30
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 40
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 50
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 60
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 70
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 80
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 90
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 100
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 110
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 120
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 130
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 140
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 150
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 160
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 170
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 180
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 190
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 200
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 210
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 220
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 230
    0, 1, 2, 3, 4, 5, 6, 7, 8, 9, // 240
    0, 1, 2, 3, 4, 5,             // 250
};

static const uint8_t digit_tens[0x100] =
{
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 0
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 10
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 20
    3, 3, 3, 3, 3, 3, 3, 3, 3, 3, // 30
    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, // 40
    5, 5, 5, 5, 5, 5, 5, 5, 5, 5, // 50
    6, 6, 6, 6, 6, 6, 6, 6, 6, 6, // 60
    7, 7, 7, 7, 7, 7, 7, 7, 7, 7, // 70
    8, 8, 8, 8, 8, 8, 8, 8, 8, 8, // 80
    9, 9, 9, 9, 9, 9, 9, 9, 9, 9, // 90
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 100
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 110
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 120
    3, 3, 3, 3, 3, 3, 3, 3, 3, 3, // 130
    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, // 140
    5, 5, 5, 5, 5, 5, 5, 5, 5, 5, // 150
    6, 6, 6, 6, 6, 6, 6, 6, 6, 6, // 160
    7, 7, 7, 7, 7, 7, 7, 7, 7, 7, // 170
    8, 8, 8, 8, 8, 8, 8, 8, 8, 8, // 180
    9, 9, 9, 9, 9, 9, 9, 9, 9, 9, // 190
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 200
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 210
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 220
    3, 3, 3, 3, 3, 3, 3, 3, 3, 3, // 230
    4, 4, 4, 4, 4, 4, 4, 4, 4, 4, // 240
    5, 5, 5, 5, 5, 5,             // 250
};

static const uint8_t digit_hundreds[0x100] =
{
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 0
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 10
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 20
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 30
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 40
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 50
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 60
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 70
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 80
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, // 90
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 100
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 110
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 120
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 130
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 140
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 150
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 160
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 170
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 180
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, // 190
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 200
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 210
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 220
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 230
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, // 240
    2, 2, 2, 2, 2, 2,             // 250
};

void digit_init(void)
{
    DIGITL_P = (uint8_t)digits;
    DIGITH_P = (uint8_t)(((uint16_t)digits)>> 8);
}

void digit_set(uint8_t column, uint8_t row, uint8_t digit)
{
    DATA1_P = ((digit + 1) << 3) - 1;
    DATA2_P = column;
    DATA3_P = row;
    DATA4_P = row + 8;

    // init
    __asm__ ("ldx %b", DATA4);          // Start at second-to-last row

    // loop
    __asm__ ("vl1: dex");

    __asm__ ("ldy %b", DATA1);
    __asm__ ("lda (%b),y", DIGIT);
    __asm__ ("sta %b", DATA5);
    __asm__ ("dec %b", DATA1);

    __asm__ ("txa");                    // row to a
    __asm__ ("tay");                    // row to y
    __asm__ ("lda (%b),y", LKLO);       // Get the row address
    __asm__ ("sta %b", ADDR1L);
    __asm__ ("lda (%b),y", LKHI);
    __asm__ ("sta %b", ADDR1H);
    __asm__ ("ldy %b", DATA2);          // column


    __asm__ ("lda %b", DATA5);
    __asm__ ("sta (%b),y", ADDR1L);
    __asm__ ("cpx %b", DATA3);
    __asm__ ("bne vl1");
}

uint8_t digit_ones_get(uint8_t value)
{
    return digit_ones[value];
}

uint8_t digit_tens_get(uint8_t value)
{
    return digit_tens[value];
}

uint8_t digit_hundreds_get(uint8_t value)
{
    return digit_hundreds[value];
}
